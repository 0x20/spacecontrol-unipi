import org.openhab.model.script.actions.Timer
  
var Timer timer = null

rule "Tests"
when 
	Item TestAllOff changed from OFF to ON
then
	Abort.send(OFF)
	executeCommandLine("/etc/openhab/configurations/bash-scripts/flappers.sh shut")
        executeCommandLine("/bin/sh@@-c@@/usr/bin/ssh shutdownuser@randomdude '/home/shutdownuser/spacecontrol/poweroff/SC_poweroff.sh'")
	Thread::sleep(6500)
        executeCommandLine("/etc/openhab/configurations/bash-scripts/flappers.sh down")
	Thread::sleep(6500)
        executeCommandLine("/etc/openhab/configurations/bash-scripts/flappers.sh reset")
	Thread::sleep(9000)
// wait in total 22sec definatly longer then the 20 sec countdown 
	if (Abort.state == OFF) {
		FrontLight.sendCommand(OFF)
	}
end

// == Lighting =================================================================================

rule "Front lighting"
when
	Item TopLightSwitch received update OPEN or
	Item TopLightSwitch received update CLOSED
then
	if (FrontLight.state==ON) {
		FrontLight.sendCommand(OFF)
	} else if (FrontLight.state==OFF) {
		FrontLight.sendCommand(ON)
	} else { // after reboot states are "Uninitialized"
		FrontLight.sendCommand(ON)
	}
	if (Space.state!=ON) {
		if(timer!=null) {
        	timer.cancel
            timer = null
        }
		Space.send(ON)
		PowerCeiling.sendCommand(ON)
		PowerWall.sendCommand(ON)
	}
end

rule "Back lighting"
when
	Item BottomLightSwitch received update OPEN or
	Item BottomLightSwitch received update CLOSED
then
	if (BackLight.state==ON) {
		BackLight.sendCommand(OFF)
	} else if (BackLight.state==OFF) {
		BackLight.sendCommand(ON)
	} else { // after reboot states are "Uninitialized"
		BackLight.sendCommand(ON)
	}
	if (Space.state!=ON) {
		if(timer!=null) {
        	timer.cancel
            timer = null
        }
		Space.send(ON)
		PowerCeiling.sendCommand(ON)
		PowerWall.sendCommand(ON)
	}
end

rule "All Off"
when
	Item AllOffButton changed
then
	BackLight.sendCommand(OFF)
	FrontLight.sendCommand(OFF)
	sendHttpGetRequest("http://spacecontrol.0x20.be/CMD?Space=OFF")
	Space.send(OFF)
	timer = createTimer(now.plusSeconds(300)) [|
  		PowerCeiling.sendCommand(OFF)
  		PowerWall.sendCommand(OFF)
	]
end

// == Door =====================================================================================
		
//rule "Open Door from rest API"
//when
//	Item Door received update ON
//then
//	DoorRelay.sendCommand(ON)
//	createTimer(now.plusSeconds(5)) [|
//  		DoorRelay.sendCommand(OFF)
//	]	
//end


